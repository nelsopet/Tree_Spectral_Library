#Functions to get extent of a large binary file/small header file pair

library(plyr)
library(maptools)
library(tidyverse)
library(tools)
library(raster)
library(rgdal)
library(sf)

##PJB note 7/26/2022: got extents for all directories of interest
  #one weird flight "100056_PEF_SM_22b_110m_2019_06_19_15_39_14_Orthos_raw_0_rd_rf_or"
    #is way larger (extent) than the rest

####PART 1: Create KML of each flight extent####
# 'path' is a directory that contains orthorectified reflectance data from one region
# within this directory we will need to pull the OR data folders (NOT white or dark)
# then within these dirs we just want or.hdr data 

###path_Deboullie <-"M:/MSGC_DATA/Deboullie/Imagery/"
###path_Howland <-"M:/MSGC_DATA/Howland/Imagery/"
###path_Neil_Ash_Sites <-"M:/MSGC_DATA/Neil_AshSites/"
###path_PEF_Demerit <-"M:/MSGC_DATA/PEF-Demerit/Imagery/"


path <- "M:/MSGC_DATA/Neil_AshSites/"

#define output paths
  # these also need to be customized to match directory
indiv_output <- "M:/MSGC_DATA/Tree_Spec_Lib/Outputs/Extents/Neil_AshSites/Individual_extents/"
combined_output <- "M:/MSGC_DATA/Tree_Spec_Lib/Outputs/Extents/Neil_AshSites/"

#get extents loop
# this is a function that pulls the CRS and geometry of flight paths from 
  # orthorectified reflectance header files within a given directory
get_extents <- function(path) 
{
  orthos1 <- list.dirs(path)
  orthos <- subset(orthos1, grepl("*rtho*", orthos1)==TRUE)
  files<-list.files(orthos, full.names = TRUE)
  #bring in rd_rf_or.hdr files
  filenames1<- subset(files,grepl("rd_rf_or.hdr",files)==TRUE|grepl("rd_rf_oror.HDR",files)==TRUE)
  #drop .hdr
  filenames<-file_path_sans_ext(filenames1)  
  #bring in binary files as rasters
  fileread<-lapply(1:length(filenames), function(x) {raster(filenames[x])})  
  #extract proj and datum from rasters
  file_crs<-lapply(fileread,crs)  #%>% unlist() 
  #extract extents from rasters
  ext_out<-lapply(fileread, extent)
  #extract file path (for flight ID info)
  file_path <- lapply(fileread, filename)
  #combine proj, datum, extent infos
  file_list<-list(file_crs,ext_out, file_path)
  return(file_list)
}

#make list from get_extents function
#this is a nested list which carries along both CRS and geometry of flight paths
file_extents<-lapply(path,get_extents)
#reformat list
file_extents<-unlist(file_extents, recursive = FALSE)

##Function writes out KMLs of every spatial extent in file_extents generated by prior function
file_polys<-lapply(1:length(file_extents[[2]]), 
                   function(x)
                   { 
                     r<-as(file_extents[[2]][[x]],"SpatialPolygons") 
                     r_crs<-unlist(file_extents[[1]][[x]])
                     crs(r)<-r_crs
                     r_df<-as(r,"SpatialPolygonsDataFrame")
                     r_df_proj <- spTransform(r_df, CRS("+proj=longlat +datum=WGS84"))
                     r_names_list <- unlist(file_extents[[3]])
                     r_name1 <- sub(".*Imagery\\\\", "", r_names_list)
                     r_name <- gsub("\\\\", "_", r_name1)
                     r_out <- kmlPolygons(obj = r_df_proj, kmlfile = paste(indiv_output, r_name[x],".kml",sep=""), name = r_name[x])
                     return(r_out)
                   })
####PART 2: Combine all KMLs into one####

#this method uses st_read into a list
#uses only geometry from individual flight kmls (no CRS)

#list files in directory
kml_files <- list.files(indiv_output)

#make list of kml inputs
all_kmls_list <- lapply(1:length(kml_files), 
                        function(x) {
                          st_read(paste(indiv_output, "/", kml_files[x], sep = ""))})
#convert to df
all_kmls_df <- do.call(rbind, all_kmls_list)

#write combined KML file
st_write(all_kmls_df, paste(combined_output, "/", "Howland_all.kml", sep = ""), driver = "kml")

#write to combined shapefile
#st_write(all_kmls_df, paste(combined_output, "/", "PEF_all.shp", sep = ""), driver = "ESRI Shapefile")



################################################END############################


